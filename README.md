# gopipe

Легковесная библиотека для построения потоковых пайплайнов на Go, а также реализация демострационной задачи по по вычислению MD5-хешей файлов.


## Описание

Библиотека позволяет собирать пайплайны из независимых нод (узлов), которые обмениваются данными через каналы.
Каждая нода может иметь несколько входов и выходов.

В демонстрационной задаче реализовано:

 - Рекурсивный обход заданной директории

 - Параллельное вычисление MD5-хешей для каждого файла

 - Гибкая настройка степени параллелизма

## Как это работает

Пайплайн состоит из трёх основных нод:

 - DirWalker — обходит директорию и отправляет найденные файлы дальше по пайплайну.

 - MD5Worker — получает пути к файлам и параллельно вычисляет их MD5-хеши.

 - ResultSink — принимает результаты и выводит их в лог.

Вся коммуникация между нодами происходит через каналы.



## Быстрый старт

1.  **Клонируйте репозиторий:**

    ```bash
    git clone <URL_ВАШЕГО_РЕПОЗИТОРИЯ>
    cd gopipe
    ```

2.  **Запустите демонстрационную задачу:**

    ```bash
    go run ./cmd/demo/main.go -dir "./path/to/your/directory" -p 20
    ```

      * `-dir`: путь к директории для обхода (по умолчанию текущая).
      * `-p`: степень параллелизма для MD5 (по умолчанию 10).

 3. **Пример запуска для текущей директории с параллелизмом по умолчанию:**

    ```bash
    go run ./cmd/demo/main.go
    ```

## Архитектура и устройство

**Интерфейс ноды**

Каждая нода реализует примерно такой интерфейс:

```golang
type Node interface {
    In() []<-chan T
    Out() []chan<- T
    Run(ctx context.Context) error
}
```
 - In() — возвращает срез входных каналов.
 - Out() — возвращает срез выходных каналов.
 - Run(ctx) — запускает обработку данных, слушая входы и отправляя результаты в выходы.

**Пример построения пайплайна**

*DirWalker:*
 - Не имеет входов.
 - Находит все файлы в директории и отправляет их пути в выходной канал.

*MD5Worker:*
 - Получает пути файлов из входного канала.
 - Параллельно вычисляет MD5-хеши (можно задать количество воркеров).
 - Отправляет результаты (структура FileHash) в выходной канал.

*ResultSink:*
 - Получает результаты из входного канала.

**Соединение нод**

- Соединение нод происходит вручную в main.go.
- Для каждого канала явно указывается, какой выход какой ноды подключён к какому входу следующей.

Пример:
```golang
walkToMd5 := make(chan string)
md5ToSink := make(chan internal.FileHash)

dirWalker.Out()[0] = walkToMd5
md5Worker.In()[0] = walkToMd5
md5Worker.Out()[0] = md5ToSink
resultSink.In()[0] = md5ToSink
```

**Параллелизм**

- В MD5Worker реализована возможность задавать количество параллельных воркеров через параметр -p.
- Каждый воркер независимо обрабатывает свой файл, что позволяет эффективно использовать ресурсы.

**Корректная остановка пайплайна**

- Для graceful shutdown используется контекст (context.Context).
- При ошибке или сигнале (например, Ctrl+C) контекст отменяется.
- Ошибки из всех нод передаются в основной поток управления через канал ошибок.

## Требования

- Go 1.21 или выше
- Только стандартная библиотека

-----
